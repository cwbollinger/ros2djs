<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<script src="https://static.robotwebtools.org/EaselJS/current/easeljs.js"></script>
<script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script src="https://static.robotwebtools.org/roslibjs/current/roslib.js"></script>
<script src="../build/ros2d.js"></script>

<script>
  /**
   * Setup all visualization elements when the page is loaded.
   */
  function init() {
    // Connect to ROS.
    var ros = new ROSLIB.Ros({
      url : 'ws://bandit.engr.oregonstate.edu:9090'
    });

    var nav_topic = new ROSLIB.Topic({
      ros : ros,
      name : '/move_base_simple/goal',
      messageType : 'geometry_msgs/PoseStamped'
    });

    var nav_goal_topic = new ROSLIB.Topic({
      ros : ros,
      name : '/move_base/current_goal',
      messageType : 'geometry_msgs/PoseStamped'
    });

    console.log("creating TFClient");
    var tfClient = new ROSLIB.TFClient({
      ros : ros,
      fixedFrame : 'map',
      angularThres : 0.01,
      transThres : 0.01
    });

    var marker = new ROS2D.ArrowShape({size:0.5, strokeSize:0.01});

    tfClient.subscribe('base_link', function(tf) {
      console.log(tf);
      marker.x = tf.translation.x
      marker.y = -tf.translation.y
      marker.rotation = -180.0 / Math.PI * Math.atan2(2*tf.rotation.w*tf.rotation.z, 1-2*tf.rotation.z*tf.rotation.z)
    });

    // Create the main viewer.
    var viewer = new ROS2D.Viewer({
      divID : 'map',
      width : 900,
      height : 500
    });

    // Setup the map client.
    var gridClient = new ROS2D.OccupancyGridClient({
      ros : ros,
      rootObject : viewer.scene,
      // Use this property in case of continuous updates			
      continuous: true
    });

    // Scale the canvas to fit to the map
    gridClient.on('change', function() {
      viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
      viewer.shift(gridClient.currentGrid.pose.position.x, gridClient.currentGrid.pose.position.y);
    });

    viewer.addObject(marker);

    var nav_goal = null;
    var nav_marker_width=0;
    var nav_marker_height=0;

    function showNavGoal(msg) {
      console.log(evt);
      x_offset = gridClient.currentGrid.pose.position.x;
      y_offset = gridClient.currentGrid.pose.position.y;
      //console.log(gridClient.currentGrid.pose);
      //console.log('Pixel Coordinates');
      //console.log(evt.stageX + ', ' + evt.stageY);
      //console.log('Scaled Coordinates');
      //console.log(evt.stageX/viewer.scene.scaleX + ', ' + evt.stageY/viewer.scene.scaleY);
      //console.log('Offset');
      //console.log(x_offset + ', ' + y_offset);
      x_click_map = evt.stageX/viewer.scene.scaleX+x_offset;
      y_click_map = evt.stageY/viewer.scene.scaleY+y_offset;
      //console.log('Transformed click coordinates');
      console.log(x_click_map + ', ' +  y_click_map);
      if(nav_goal == null) {
        var dot_graphic = new createjs.Graphics();
        dot_graphic.setStrokeStyle(1);
        dot_graphic.beginFill(createjs.Graphics.getRGB(0,255,0));
        nav_marker_width = 20/viewer.scene.scaleX;
        nav_marker_height = 20/viewer.scene.scaleY;
        dot_graphic.drawEllipse(-nav_marker_width/2,-nav_marker_height/2,nav_marker_width,nav_marker_height);
        nav_goal = new createjs.Shape(dot_graphic);
        viewer.addObject(s);
      }
    }

    nav_goal_topic.subscribe(showNavGoal);

    var s = null;
    var marker_width=0;
    var marker_height=0;

    function handleClick(evt) {
      console.log(evt);
      x_offset = gridClient.currentGrid.pose.position.x;
      y_offset = gridClient.currentGrid.pose.position.y;
      //console.log(gridClient.currentGrid.pose);
      //console.log('Pixel Coordinates');
      //console.log(evt.stageX + ', ' + evt.stageY);
      //console.log('Scaled Coordinates');
      //console.log(evt.stageX/viewer.scene.scaleX + ', ' + evt.stageY/viewer.scene.scaleY);
      //console.log('Offset');
      //console.log(x_offset + ', ' + y_offset);
      x_click_map = evt.stageX/viewer.scene.scaleX+x_offset;
      y_click_map = evt.stageY/viewer.scene.scaleY+y_offset;
      //console.log('Transformed click coordinates');
      console.log(x_click_map + ', ' +  y_click_map);

      if(s == null) {
        var dot_graphic = new createjs.Graphics();
        dot_graphic.setStrokeStyle(1);
        dot_graphic.beginFill(createjs.Graphics.getRGB(255,0,0));
        marker_width = 10/viewer.scene.scaleX;
        marker_height = 10/viewer.scene.scaleY;
        dot_graphic.drawEllipse(-marker_width/2,-marker_height/2,marker_width,marker_height);
        s = new createjs.Shape(dot_graphic);
        viewer.addObject(s);
      }
      s.x = x_click_map;
      s.y = y_click_map;

      nav_topic.publish(new ROSLIB.Message({
        header: {
          frame_id: 'map'
        },
        pose: {
          position: {
            x: x_click_map,
            y: -y_click_map,
            z: 0.0
          },
          orientation: {
            x: 0.0,
            y: 0.0,
            z: 0.0,
            w: 1.0
          }
        }
      }));
    }

    viewer.scene.on("stagemousedown", handleClick);
  }
</script>
</head>

<body onload="init()">
  <h1>Continuous Map Example</h1>
  <p>
    Use any method to publish continuous updates to topic /map and use this page to visualize updates. Follow these commands:
  </p>
  <ol>
    <li><tt>roscore</tt></li>
    <li><tt>(method of choice to publish to /map)</tt></li>
    <li><tt>roslaunch rosbridge_server rosbridge_websocket.launch</tt></li>
  </ol>
  <div id="map"></div>
</body>
</html>
